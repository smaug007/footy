{% extends "base.html" %}

{% block title %}My Predictions - Corner Prediction History{% endblock %}

{% block content %}

<!-- Page Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="mb-0">
                    <i class="fas fa-history text-primary"></i> My Predictions
                </h1>
                <p class="text-muted mb-0">Your corner prediction history and performance tracking</p>
            </div>
            <div>
                <a href="{{ url_for('index') }}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Generate New Prediction
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Summary Stats -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <i class="fas fa-chart-line fa-2x mb-2"></i>
                <h3 class="mb-1">{{ accuracy_stats.total }}</h3>
                <small>Total Predictions</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <i class="fas fa-check-circle fa-2x mb-2"></i>
                <h3 class="mb-1">{{ accuracy_stats.verified }}</h3>
                <small>Verified Results</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <i class="fas fa-percentage fa-2x mb-2"></i>
                <h3 class="mb-1">{{ "%.1f"|format(accuracy_stats.over_5_5_accuracy) }}%</h3>
                <small>Over 5.5 Accuracy</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body text-center">
                <i class="fas fa-clock fa-2x mb-2"></i>
                <h3 class="mb-1">{{ accuracy_stats.pending }}</h3>
                <small>Pending Verification</small>
            </div>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <form method="GET" class="row g-3 align-items-end">
                    <div class="col-md-3">
                        <label for="season" class="form-label">
                            <i class="fas fa-calendar"></i> Season Filter
                        </label>
                        <select name="season" id="season" class="form-select">
                            <option value="">All Seasons</option>
                            {% for season in available_seasons %}
                            <option value="{{ season }}" {% if season == current_season_filter %}selected{% endif %}>
                                {{ season }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="limit" class="form-label">
                            <i class="fas fa-list"></i> Show Results
                        </label>
                        <select name="limit" id="limit" class="form-select">
                            <option value="25" {% if current_limit == 25 %}selected{% endif %}>Last 25</option>
                            <option value="50" {% if current_limit == 50 %}selected{% endif %}>Last 50</option>
                            <option value="100" {% if current_limit == 100 %}selected{% endif %}>Last 100</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-filter"></i> Apply Filters
                        </button>
                        <a href="{{ url_for('predictions_history') }}" class="btn btn-outline-secondary ms-2">
                            <i class="fas fa-times"></i> Clear
                        </a>
                    </div>
                    <div class="col-md-3 text-end">
                        <small class="text-muted">
                            Showing {{ predictions|length }} predictions
                        </small>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Predictions List -->
{% if predictions %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-list"></i> Prediction History
                    {% if current_season_filter %}
                        <span class="badge bg-primary ms-2">{{ current_season_filter }} Season</span>
                    {% endif %}
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Match</th>
                                <th>Date</th>
                                <th>Prediction</th>
                                <th>Confidence</th>
                                <th>Goal Scores</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for prediction in predictions %}
                            <tr>
                                <td>
                                    <div class="fw-bold">{{ prediction.home_team_name }} vs {{ prediction.away_team_name }}</div>
                                    <small class="text-muted">Season {{ prediction.season }}</small>
                                </td>
                                <td>
                                    <div>{{ prediction.match_date[:10] if prediction.match_date else 'TBD' }}</div>
                                    <small class="text-muted">{{ prediction.created_at[:10] }}</small>
                                </td>
                                <td>
                                    <div class="fw-bold text-primary">{{ "%.1f"|format(prediction.predicted_total_corners) }} corners</div>
                                    <small class="text-muted">
                                        Home: {{ "%.1f"|format(prediction.home_team_expected) }} | 
                                        Away: {{ "%.1f"|format(prediction.away_team_expected) }}
                                    </small>
                                </td>
                                <td>
                                    <div>
                                        <span class="badge bg-{% if prediction.confidence_5_5 >= 70 %}success{% elif prediction.confidence_5_5 >= 50 %}warning{% else %}danger{% endif %} me-1">
                                            O5.5: {{ "%.0f"|format(prediction.confidence_5_5) }}%
                                        </span>
                                    </div>
                                    <div class="mt-1">
                                        <span class="badge bg-{% if prediction.confidence_6_5 >= 70 %}success{% elif prediction.confidence_6_5 >= 50 %}warning{% else %}danger{% endif %}">
                                            O6.5: {{ "%.0f"|format(prediction.confidence_6_5) }}%
                                        </span>
                                    </div>
                                </td>
                                <td>
                                    {% if prediction.home_team_score_probability is not none and prediction.away_team_score_probability is not none %}
                                        <div>
                                            <span class="badge bg-{% if prediction.home_team_score_probability >= 60 %}success{% elif prediction.home_team_score_probability >= 40 %}warning{% else %}secondary{% endif %} me-1">
                                                üè† {{ "%.0f"|format(prediction.home_team_score_probability) }}%
                                            </span>
                                        </div>
                                        <div class="mt-1">
                                            <span class="badge bg-{% if prediction.away_team_score_probability >= 60 %}success{% elif prediction.away_team_score_probability >= 40 %}warning{% else %}secondary{% endif %}">
                                                ‚úàÔ∏è {{ "%.0f"|format(prediction.away_team_score_probability) }}%
                                            </span>
                                        </div>
                                    {% else %}
                                        <span class="text-muted">
                                            <i class="fas fa-question-circle"></i> Not Available
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if prediction.verified_date %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check-circle"></i> Verified
                                        </span>
                                        {% if prediction.verified_manually %}
                                            <br><small class="text-muted">Manual</small>
                                        {% else %}
                                            <br><small class="text-muted">Auto</small>
                                        {% endif %}
                                    {% else %}
                                        <span class="badge bg-warning">
                                            <i class="fas fa-clock"></i> Pending
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group-vertical btn-group-sm" role="group">
                                        <a href="/analysis/{{ prediction.home_team_id }}/{{ prediction.away_team_id }}/{{ prediction.season }}" 
                                           class="btn btn-outline-primary btn-sm">
                                            <i class="fas fa-microscope"></i> View Analysis
                                        </a>
                                        <a href="/analysis/goals/{{ prediction.home_team_id }}/{{ prediction.away_team_id }}/{{ prediction.season }}" 
                                           class="btn btn-outline-success btn-sm">
                                            <i class="fas fa-futbol"></i> Goal Analysis
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Prediction Performance Analysis -->
{% if accuracy_stats.verified > 0 %}
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-chart-bar"></i> Performance Summary
                </h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <div class="border-end">
                            <h4 class="text-success">{{ "%.1f"|format(accuracy_stats.over_5_5_accuracy) }}%</h4>
                            <small class="text-muted">Over 5.5 Accuracy</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <h4 class="text-warning">{{ "%.1f"|format(accuracy_stats.over_6_5_accuracy) }}%</h4>
                        <small class="text-muted">Over 6.5 Accuracy</small>
                    </div>
                </div>
                <hr>
                <div class="row text-center">
                    <div class="col-12">
                        <small class="text-muted">
                            Based on {{ accuracy_stats.verified }} verified predictions
                            <br>{{ accuracy_stats.pending }} predictions still pending verification
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-info-circle"></i> Tips for Better Predictions
                </h6>
            </div>
            <div class="card-body">
                <ul class="list-unstyled small">
                    <li><i class="fas fa-lightbulb text-warning"></i> Higher confidence predictions (70%+) tend to be more accurate</li>
                    <li><i class="fas fa-chart-line text-info"></i> Teams with consistent performance are easier to predict</li>
                    <li><i class="fas fa-history text-primary"></i> Use head-to-head data for additional context</li>
                    <li><i class="fas fa-database text-success"></i> More historical data improves prediction quality</li>
                </ul>
                <div class="mt-3">
                    <a href="{{ url_for('index') }}" class="btn btn-sm btn-outline-primary">
                        Generate New Prediction
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% else %}
<!-- No Predictions Found -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body text-center py-5">
                <i class="fas fa-chart-line fa-4x text-muted mb-4"></i>
                <h3 class="text-muted">No Predictions Found</h3>
                <p class="text-muted">
                    {% if current_season_filter %}
                        No predictions found for the {{ current_season_filter }} season.
                        <br>Try removing the season filter or selecting a different season.
                    {% else %}
                        You haven't generated any predictions yet.
                        <br>Start by creating your first corner prediction!
                    {% endif %}
                </p>
                <div class="mt-4">
                    <a href="{{ url_for('index') }}" class="btn btn-primary btn-lg">
                        <i class="fas fa-plus"></i> Generate Your First Prediction
                    </a>
                    {% if current_season_filter %}
                        <a href="{{ url_for('predictions_history') }}" class="btn btn-outline-secondary btn-lg ms-2">
                            <i class="fas fa-times"></i> Clear Filters
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
.table th {
    border-top: none;
    font-weight: 600;
    font-size: 0.875rem;
}
.prediction-status {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
}
.accuracy-indicator {
    font-size: 0.75rem;
}
.btn-group-vertical > .btn {
    margin-bottom: 0.125rem;
}
.btn-group-vertical > .btn:last-child {
    margin-bottom: 0;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Auto-refresh page every 5 minutes to pick up new predictions
setTimeout(function() {
    location.reload();
}, 300000);

// Add tooltips to badges and buttons
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Bootstrap tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    });
});
</script>
{% endblock %}
