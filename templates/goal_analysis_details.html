{% extends "base.html" %}

{% block title %}Goal Analysis - {{ home_team.name }} vs {{ away_team.name }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Error handling -->
    {% if not analysis %}
    <div class="alert alert-warning" role="alert">
        <h4 class="alert-heading">Analysis Unavailable</h4>
        <p>{{ error_message or "Unable to generate goal analysis for this match." }}</p>
        <hr>
        <p class="mb-0">This may be due to insufficient historical data for the selected time period.</p>
    </div>
    <div class="text-center">
        <a href="/" class="btn btn-primary">Return to Dashboard</a>
    </div>
    {% else %}
    
    <!-- Time-Travel Mode Indicator -->
    {% if request.args.get('backtest_date') %}
    <div class="alert alert-info border-0 mb-3" style="background: linear-gradient(135deg, #17a2b8, #138496); color: white;">
        <div class="d-flex align-items-center">
            <i class="fas fa-history me-2"></i>
            <div>
                <strong>üïí Time-Travel Mode</strong> - Historical Analysis Only
                <small class="d-block opacity-75">Data cutoff: {{ request.args.get('backtest_date') }} (no future data included)</small>
            </div>
        </div>
    </div>
    
    <div class="alert alert-warning border-0 mb-3">
        <div class="d-flex align-items-center">
            <i class="fas fa-info-circle me-2"></i>
            <div>
                <strong>üìä Confidence Score Note:</strong> For accurate goal scoring probabilities in backtesting mode, refer to the <strong>backtesting table</strong> values. 
                These detail pages show historical analysis patterns but may contain template placeholder values.
                <small class="d-block mt-1"><strong>Authoritative source:</strong> Backtesting table confidence scores (calculated by prediction engine)</small>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Analysis Header -->
    <div class="analysis-header bg-gradient-success text-white p-4 mb-4 rounded">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="mb-2">
                    <i class="fas fa-futbol"></i> Goal Analysis
                </h2>
                <h4 class="mb-0">
                    <strong class="text-white">{{ home_team.name }}</strong> 
                    <span class="mx-2">vs</span> 
                    <strong class="text-white">{{ away_team.name }}</strong>
                </h4>
                <p class="mb-0 mt-2">
                    <i class="fas fa-calendar"></i> Season {{ season }} | 
                    <i class="fas fa-chart-line"></i> BTTS Analysis
                </p>
            </div>
            <div class="text-end">
                <!-- Navigation Buttons -->
                <div class="btn-group" role="group">
                    <a href="{{ url_for('index') }}" class="btn btn-outline-light">
                        <i class="fas fa-home"></i> Dashboard
                    </a>
                    <a href="{{ url_for('analysis_details', home_team_id=home_team.id, away_team_id=away_team.id, season=season, backtest_date=request.args.get('backtest_date')) if request.args.get('backtest_date') else url_for('analysis_details', home_team_id=home_team.id, away_team_id=away_team.id, season=season) }}" class="btn btn-outline-light">
                        <i class="fas fa-flag"></i> Corner Analysis
                    </a>
                    <span class="btn btn-light active">
                        <i class="fas fa-futbol"></i> Goal Analysis
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- BTTS Prediction Summary -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-bullseye"></i> Both Teams To Score (BTTS) Prediction</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="prediction-stat">
                                <h2 class="text-primary">{{ "%.1f"|format(analysis['prediction_summary']['btts_probability']) }}%</h2>
                                <p class="text-muted mb-0">BTTS Probability</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="prediction-stat">
                                <h2 class="text-success">{{ "%.1f"|format(analysis['prediction_summary']['home_team_score_probability']) }}%</h2>
                                <p class="text-muted mb-0">{{ home_team.name }} Scoring</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="prediction-stat">
                                <h2 class="text-info">{{ "%.1f"|format(analysis['prediction_summary']['away_team_score_probability']) }}%</h2>
                                <p class="text-muted mb-0">{{ away_team.name }} Scoring</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="prediction-stat">
                                <h2 class="text-warning">{{ "%.0f"|format(analysis['quality_metrics']['confidence_score']) }}%</h2>
                                <p class="text-muted mb-0">Confidence</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Data Transparency Indicator -->
                    {% if analysis['prediction_summary']['data_transparency_note'] %}
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="alert {% if analysis['prediction_summary']['fallback_estimation_info']['uses_fallback_estimation'] %}alert-warning{% else %}alert-success{% endif %} py-2" role="alert">
                                <small><i class="fas fa-info-circle me-1"></i> 
                                <strong>Data Source:</strong> {{ analysis['prediction_summary']['data_transparency_note'] }}
                                {% if analysis['prediction_summary']['fallback_estimation_info']['uses_fallback_estimation'] %}
                                <br><i class="fas fa-chart-line me-1"></i> 
                                <strong>Method:</strong> Missing goal data estimated using corner-to-goal correlation analysis
                                {% endif %}
                                </small>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Team Analysis Cards -->
    <div class="row mb-4">
        <!-- Home Team Analysis -->
        <div class="col-md-6">
            <div class="card team-analysis-card h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-home"></i> {{ home_team.name }} (Home Analysis)
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Team Statistics -->
                    <div class="row mb-3">
                        <div class="col-6">
                            <div class="text-center p-2 bg-success text-white rounded">
                                <h6 class="mb-1">{{ "%.1f"|format(analysis['prediction_summary']['home_team_score_probability']) }}%</h6>
                                <small>Scoring Rate</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center p-2 bg-secondary text-white rounded">
                                <h6 class="mb-1">{{ analysis['home_team_analysis']['total_games'] }}</h6>
                                <small>Games Analyzed</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Data Source Transparency for Home Team -->
                    {% if analysis['home_team_analysis']['fallback_estimation_used'] %}
                    <div class="alert alert-warning py-1 mt-2 mb-0" role="alert">
                        <small><i class="fas fa-exclamation-triangle me-1"></i> 
                        <strong>Data Note:</strong> {{ analysis['home_team_analysis']['real_goal_data_matches'] }} real + {{ analysis['home_team_analysis']['estimated_goal_data_matches'] }} estimated goal data
                        </small>
                    </div>
                    {% elif analysis['home_team_analysis']['real_goal_data_matches'] %}
                    <div class="alert alert-success py-1 mt-2 mb-0" role="alert">
                        <small><i class="fas fa-check-circle me-1"></i> 
                        <strong>Data Quality:</strong> All {{ analysis['home_team_analysis']['real_goal_data_matches'] }} matches use real goal data
                        </small>
                    </div>
                    {% endif %}

                    <!-- Recent HOME Goal Performance -->
                    <div class="mt-3">
                        <h6 class="text-primary">üè† Recent HOME Games Performance</h6>
                        {% if analysis['home_team_analysis']['recent_matches'] and analysis['home_team_analysis']['recent_matches']|length > 0 %}
                            <div class="table-responsive">
                                <table class="table table-sm matches-table">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Opponent</th>
                                            <th>Pos</th>
                                            <th>Score</th>
                                            <th>BTTS</th>
                                            <th>Venue</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for match in analysis['home_team_analysis']['recent_matches'][:10] %}
                                        <tr>
                                            <td>{{ match.match_date or 'N/A' }}</td>
                                            <td>{{ match.opponent or 'Unknown' }}</td>
                                            <td>
                                                <span class="badge bg-secondary">#{{ match.opponent_position or '?' }}</span>
                                            </td>
                                            <td>
                                                <span class="badge bg-{% if (match.goals_scored or 0) > 0 %}success{% else %}secondary{% endif %}">
                                                    {{ match.goals_scored or 0 }}-{{ match.goals_conceded or 0 }}
                                                </span>
                                            </td>
                                            <td>
                                                <span class="badge bg-{% if match.btts %}success{% else %}danger{% endif %}">
                                                    {% if match.btts %}Yes{% else %}No{% endif %}
                                                </span>
                                            </td>
                                            <td>
                                                <span class="badge bg-primary">{{ match.venue or 'H' }}</span>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <div class="bg-light p-3 rounded text-center">
                                <i class="fas fa-home text-primary"></i>
                                <br><small class="text-muted">HOME Scoring Rate: {{ "%.1f"|format(analysis['prediction_summary']['home_team_score_probability']) }}%</small>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Away Team Analysis -->
        <div class="col-md-6">
            <div class="card team-analysis-card h-100">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-plane"></i> {{ away_team.name }} (Away Analysis)
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Team Statistics -->
                    <div class="row mb-3">
                        <div class="col-6">
                            <div class="text-center p-2 bg-info text-white rounded">
                                <h6 class="mb-1">{{ "%.1f"|format(analysis['prediction_summary']['away_team_score_probability']) }}%</h6>
                                <small>Scoring Rate</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center p-2 bg-secondary text-white rounded">
                                <h6 class="mb-1">{{ analysis['away_team_analysis']['total_games'] }}</h6>
                                <small>Games Analyzed</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Data Source Transparency for Away Team -->
                    {% if analysis['away_team_analysis']['fallback_estimation_used'] %}
                    <div class="alert alert-warning py-1 mt-2 mb-0" role="alert">
                        <small><i class="fas fa-exclamation-triangle me-1"></i> 
                        <strong>Data Note:</strong> {{ analysis['away_team_analysis']['real_goal_data_matches'] }} real + {{ analysis['away_team_analysis']['estimated_goal_data_matches'] }} estimated goal data
                        </small>
                    </div>
                    {% elif analysis['away_team_analysis']['real_goal_data_matches'] %}
                    <div class="alert alert-success py-1 mt-2 mb-0" role="alert">
                        <small><i class="fas fa-check-circle me-1"></i> 
                        <strong>Data Quality:</strong> All {{ analysis['away_team_analysis']['real_goal_data_matches'] }} matches use real goal data
                        </small>
                    </div>
                    {% endif %}

                    <!-- Recent AWAY Goal Performance -->
                    <div class="mt-3">
                        <h6 class="text-secondary">‚úàÔ∏è Recent AWAY Games Performance</h6>
                        {% if analysis['away_team_analysis']['recent_matches'] and analysis['away_team_analysis']['recent_matches']|length > 0 %}
                            <div class="table-responsive">
                                <table class="table table-sm matches-table">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Opponent</th>
                                            <th>Pos</th>
                                            <th>Score</th>
                                            <th>BTTS</th>
                                            <th>Venue</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for match in analysis['away_team_analysis']['recent_matches'][:10] %}
                                        <tr>
                                            <td>{{ match.match_date or 'N/A' }}</td>
                                            <td>{{ match.opponent or 'Unknown' }}</td>
                                            <td>
                                                <span class="badge bg-secondary">#{{ match.opponent_position or '?' }}</span>
                                            </td>
                                            <td>
                                                <span class="badge bg-{% if (match.goals_scored or 0) > 0 %}success{% else %}secondary{% endif %}">
                                                    {{ match.goals_scored or 0 }}-{{ match.goals_conceded or 0 }}
                                                </span>
                                            </td>
                                            <td>
                                                <span class="badge bg-{% if match.btts %}success{% else %}danger{% endif %}">
                                                    {% if match.btts %}Yes{% else %}No{% endif %}
                                                </span>
                                            </td>
                                            <td>
                                                <span class="badge bg-primary">{{ match.venue or 'A' }}</span>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <div class="bg-light p-3 rounded text-center">
                                <i class="fas fa-plane text-secondary"></i>
                                <br><small class="text-muted">AWAY Scoring Rate: {{ "%.1f"|format(analysis['prediction_summary']['away_team_score_probability']) }}%</small>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Calculation Breakdown -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card team-analysis-card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-calculator"></i> Goal Analysis Methodology</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle"></i> Analysis Overview</h6>
                        <p class="mb-0">Our goal analysis uses <strong>comprehensive historical data</strong> with dynamic weighting to predict Both Teams To Score (BTTS) probability. The system analyzes each team's complete performance history (both home and away games) for well-rounded predictions.</p>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card border-primary mb-3">
                                <div class="card-header bg-primary text-white">
                                    <i class="fas fa-home"></i> {{ home_team.name }} Analysis
                                </div>
                                <div class="card-body">
                                    <p><strong>Matches Analyzed:</strong> {{ analysis['home_team_analysis']['total_games'] }}</p>
                                    <p><strong>Scoring Rate:</strong> {{ "%.1f"|format(analysis['prediction_summary']['home_team_score_probability']) }}%</p>
                                    <p class="mb-0"><strong>Conceding Rate:</strong> {{ "%.1f"|format(100 - analysis['prediction_summary']['home_team_score_probability']) }}%</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-secondary mb-3">
                                <div class="card-header bg-secondary text-white">
                                    <i class="fas fa-plane"></i> {{ away_team.name }} Analysis
                                </div>
                                <div class="card-body">
                                    <p><strong>Matches Analyzed:</strong> {{ analysis['away_team_analysis']['total_games'] }}</p>
                                    <p><strong>Scoring Rate:</strong> {{ "%.1f"|format(analysis['prediction_summary']['away_team_score_probability']) }}%</p>
                                    <p class="mb-0"><strong>Conceding Rate:</strong> {{ "%.1f"|format(100 - analysis['prediction_summary']['away_team_score_probability']) }}%</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card border-success">
                        <div class="card-header bg-success text-white">
                            <i class="fas fa-bullseye"></i> BTTS Confidence Calculation
                        </div>
                        <div class="card-body">
                            <div class="mb-4">
                                <h6><i class="fas fa-calculator"></i> <strong>Sophisticated BTTS Calculation Breakdown</strong></h6>
                                
                                {% if analysis['calculation_breakdown'] %}
                                <!-- Home Team Calculation -->
                                <div class="alert alert-info mb-3">
                                    <h6><i class="fas fa-home"></i> <strong>{{ home_team.name }} Scoring Probability</strong></h6>
                                    <p><strong>Attack Rate:</strong> {{ "%.1f"|format(analysis['calculation_breakdown']['home_team_calculation']['attack_rate']) }}% ({{ home_team.name }} scores 1+ goals in home games)</p>
                                    <p><strong>Opponent Defense Vulnerability:</strong> {{ "%.1f"|format(analysis['calculation_breakdown']['home_team_calculation']['opponent_defense_vulnerability']) }}% ({{ away_team.name }} concedes 1+ goals in away games)</p>
                                    <p><strong>Dynamic Weights:</strong> Attack {{ "%.0f"|format(analysis['calculation_breakdown']['home_team_calculation']['dynamic_weights'][0] * 100) }}% | Defense {{ "%.0f"|format(analysis['calculation_breakdown']['home_team_calculation']['dynamic_weights'][1] * 100) }}%</p>
                                    <p><strong>Calculation:</strong> <code>{{ analysis['calculation_breakdown']['home_team_calculation']['calculation_formula'] }}</code></p>
                                    <p><strong>Reasoning:</strong> {{ analysis['calculation_breakdown']['home_team_calculation']['reasoning'] }}</p>
                                </div>
                                
                                <!-- Away Team Calculation -->
                                <div class="alert alert-warning mb-3">
                                    <h6><i class="fas fa-plane"></i> <strong>{{ away_team.name }} Scoring Probability</strong></h6>
                                    <p><strong>Attack Rate:</strong> {{ "%.1f"|format(analysis['calculation_breakdown']['away_team_calculation']['attack_rate']) }}% ({{ away_team.name }} scores 1+ goals in away games)</p>
                                    <p><strong>Opponent Defense Vulnerability:</strong> {{ "%.1f"|format(analysis['calculation_breakdown']['away_team_calculation']['opponent_defense_vulnerability']) }}% ({{ home_team.name }} concedes 1+ goals in home games)</p>
                                    <p><strong>Dynamic Weights:</strong> Attack {{ "%.0f"|format(analysis['calculation_breakdown']['away_team_calculation']['dynamic_weights'][0] * 100) }}% | Defense {{ "%.0f"|format(analysis['calculation_breakdown']['away_team_calculation']['dynamic_weights'][1] * 100) }}%</p>
                                    <p><strong>Calculation:</strong> <code>{{ analysis['calculation_breakdown']['away_team_calculation']['calculation_formula'] }}</code></p>
                                    <p><strong>Reasoning:</strong> {{ analysis['calculation_breakdown']['away_team_calculation']['reasoning'] }}</p>
                                </div>
                                
                                <!-- Final BTTS Calculation -->
                                <div class="alert alert-success mb-3">
                                    <h6><i class="fas fa-bullseye"></i> <strong>Final BTTS Calculation</strong></h6>
                                    <p><strong>Formula:</strong> <code>{{ analysis['calculation_breakdown']['final_btts_calculation']['calculation_formula'] }}</code></p>
                                    <p><strong>Result:</strong> {{ "%.1f"|format(analysis['calculation_breakdown']['final_btts_calculation']['btts_probability']) }}% probability both teams score</p>
                                </div>
                                
                                {% else %}
                                <p><strong>Simplified Formula:</strong> BTTS = (Home Scoring √ó Away Scoring) + Dynamic Weighting</p>
                                <p><strong>Explanation:</strong> {{ analysis['detailed_breakdown']['methodology'] }}</p>
                                {% endif %}
                                
                                <p><strong>Data Quality:</strong> {{ analysis['detailed_breakdown']['data_transparency_note'] }}</p>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card border-primary">
                                        <div class="card-header bg-primary text-white">
                                            <i class="fas fa-home"></i> {{ home_team.name }} Scoring Analysis
                                        </div>
                                        <div class="card-body">
                                            <p><strong>Probability:</strong> {{ "%.1f"|format(analysis['prediction_summary']['home_team_score_probability']) }}%</p>
                                            <p><strong>Reasoning:</strong> {{ analysis['detailed_breakdown']['home_team_reasoning'] }}</p>
                                            <hr>
                                            <h6>Statistical Breakdown:</h6>
                                            <ul class="list-unstyled">
                                                <li><strong>Games Analyzed:</strong> {{ analysis['home_team_analysis']['total_games'] }}</li>
                                                <li><strong>Scored 1+ Goals:</strong> {{ analysis['home_team_analysis']['scores_1plus_count'] }}/{{ analysis['home_team_analysis']['total_games'] }} ({{ "%.1f"|format(analysis['home_team_analysis']['scores_1plus_rate']) }}%)</li>
                                                <li><strong>Scored 2+ Goals:</strong> {{ analysis['home_team_analysis']['scores_2plus_count'] }}/{{ analysis['home_team_analysis']['total_games'] }} ({{ "%.1f"|format(analysis['home_team_analysis']['scores_2plus_rate']) }}%)</li>
                                                <li><strong>Average Goals:</strong> {{ "%.2f"|format(analysis['home_team_analysis']['avg_goals_scored']) }}</li>
                                                <li class="text-danger"><strong>Conceded 1+ Goals:</strong> {{ analysis['home_team_analysis']['concedes_1plus_count'] }}/{{ analysis['home_team_analysis']['total_games'] }} ({{ "%.1f"|format(analysis['home_team_analysis']['concedes_1plus_rate']) }}%)</li>
                                                <li class="text-danger"><strong>Average Goals Conceded:</strong> {{ "%.2f"|format(analysis['home_team_analysis']['avg_goals_conceded']) }}</li>
                                                <li><strong>Data Quality:</strong> {{ analysis['home_team_analysis']['data_transparency'] }}</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card border-secondary">
                                        <div class="card-header bg-secondary text-white">
                                            <i class="fas fa-plane"></i> {{ away_team.name }} Scoring Analysis
                                        </div>
                                        <div class="card-body">
                                            <p><strong>Probability:</strong> {{ "%.1f"|format(analysis['prediction_summary']['away_team_score_probability']) }}%</p>
                                            <p><strong>Reasoning:</strong> {{ analysis['detailed_breakdown']['away_team_reasoning'] }}</p>
                                            <hr>
                                            <h6>Statistical Breakdown:</h6>
                                            <ul class="list-unstyled">
                                                <li><strong>Games Analyzed:</strong> {{ analysis['away_team_analysis']['total_games'] }}</li>
                                                <li><strong>Scored 1+ Goals:</strong> {{ analysis['away_team_analysis']['scores_1plus_count'] }}/{{ analysis['away_team_analysis']['total_games'] }} ({{ "%.1f"|format(analysis['away_team_analysis']['scores_1plus_rate']) }}%)</li>
                                                <li><strong>Scored 2+ Goals:</strong> {{ analysis['away_team_analysis']['scores_2plus_count'] }}/{{ analysis['away_team_analysis']['total_games'] }} ({{ "%.1f"|format(analysis['away_team_analysis']['scores_2plus_rate']) }}%)</li>
                                                <li><strong>Average Goals:</strong> {{ "%.2f"|format(analysis['away_team_analysis']['avg_goals_scored']) }}</li>
                                                <li class="text-danger"><strong>Conceded 1+ Goals:</strong> {{ analysis['away_team_analysis']['concedes_1plus_count'] }}/{{ analysis['away_team_analysis']['total_games'] }} ({{ "%.1f"|format(analysis['away_team_analysis']['concedes_1plus_rate']) }}%)</li>
                                                <li class="text-danger"><strong>Average Goals Conceded:</strong> {{ "%.2f"|format(analysis['away_team_analysis']['avg_goals_conceded']) }}</li>
                                                <li><strong>Data Quality:</strong> {{ analysis['away_team_analysis']['data_transparency'] }}</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card border-warning mt-3">
                                <div class="card-header bg-warning text-dark">
                                    <i class="fas fa-chart-line"></i> <strong>Final BTTS Calculation</strong>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <h6>Base Probability</h6>
                                            <p>{{ "%.1f"|format(analysis['prediction_summary']['home_team_score_probability']) }}% √ó {{ "%.1f"|format(analysis['prediction_summary']['away_team_score_probability']) }}% = {{ "%.1f"|format((analysis['prediction_summary']['home_team_score_probability'] * analysis['prediction_summary']['away_team_score_probability']) / 100) }}%</p>
                                        </div>
                                        <div class="col-md-4">
                                            <h6>Dynamic Weighting</h6>
                                            <p>Applied based on attack vs defense strength analysis</p>
                                        </div>
                                        <div class="col-md-4">
                                            <h6>Final BTTS Probability</h6>
                                            <p class="h4 text-success"><strong>{{ "%.1f"|format(analysis['prediction_summary']['btts_probability']) }}%</strong></p>
                                            <p><small>Confidence: {{ analysis['detailed_breakdown']['confidence'] }} ({{ "%.1f"|format(analysis['detailed_breakdown']['confidence_score']) }}%)</small></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Quality Assessment -->
    <div class="row">
        <div class="col-12">
            <div class="card team-analysis-card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-chart-bar"></i> Data Quality & Confidence</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-4">
                            <div class="p-3 bg-light rounded">
                                <h4 class="text-{{ 'success' if analysis['quality_metrics']['data_quality'] == 'Excellent' else 'warning' if analysis['quality_metrics']['data_quality'] == 'Good' else 'danger' }}">
                                    {{ analysis['quality_metrics']['data_quality'] }}
                                </h4>
                                <p class="mb-0">Data Reliability</p>
                                <small class="text-muted">{{ analysis['home_team_analysis']['total_games'] + analysis['away_team_analysis']['total_games'] }} total matches analyzed</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="p-3 bg-light rounded">
                                <h4 class="text-{{ 'success' if analysis['quality_metrics']['confidence_score'] >= 75 else 'warning' if analysis['quality_metrics']['confidence_score'] >= 50 else 'danger' }}">
                                    {{ "%.0f"|format(analysis['quality_metrics']['confidence_score']) }}%
                                </h4>
                                <p class="mb-0">Prediction Confidence</p>
                                <small class="text-muted">Algorithm reliability score</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="p-3 bg-light rounded">
                                <h4 class="text-primary">{{ "%.1f"|format(analysis['prediction_summary']['btts_probability']) }}%</h4>
                                <p class="mb-0">Final BTTS Probability</p>
                                <small class="text-muted">Both teams to score</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<style>
.prediction-stat {
    padding: 1rem;
    border-left: 4px solid #007bff;
    margin-bottom: 1rem;
}

.team-analysis-card {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border: none;
}

.analysis-header {
    background: linear-gradient(135deg, #28a745, #20c997);
}

.matches-table {
    font-size: 0.85rem;
}

.matches-table th {
    font-weight: 600;
    background-color: #f8f9fa;
}

@media (max-width: 768px) {
    .matches-table {
        font-size: 0.75rem;
    }
}
</style>
{% endblock %}